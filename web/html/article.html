<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title></title>

		<link rel="stylesheet" href="../css/bootstrap.min.css" />
		<link rel="stylesheet" href="../css/font-awesome.min.css" />
		<link rel="stylesheet" href="../css/platform.css" />
		<script type="text/javascript" src="../js/jquery.min.js" ></script>
		<script type="text/javascript" src="../js/bootstrap.min.js" ></script>


		<script type="text/javascript">


			<!--article information 初始化部分 -->
//			var aid = 7;
			var aid;
			var author_id;

//			当前用户是否关注了这个文章的作者
			var author_like = 0;

			var uid ;
			var comment_from;

            var login = false;

            var comment_depth = 0;
            var comment_count = 0;

//            默认按照时间逆序排列，
            var order = 0;

//            为了防止局部变量和全局变量的冲突，把offset -> page_offset
            var page_offset = 0;

//            登录用户是否喜欢了这篇文章
            var like = 0;

            function getSession() {

                $.ajax({
                    url : "/user/getSession.action",
                    type : "get",
                    dataType : "json",
					async : false,
                    success : function (data) {
                        if (data != null ) {

                            login = true;
                            comment_from = data.username;
                            uid = data.id;

//                        alert("uid : " + uid + " username : " + comment_from + " info : " + data.info);

//				        隐藏nav的按钮
                            $(".logIn").show();
                            $(".logOut").hide();
                        } else {

                            login = false;

                            $(".logIn").hide();
                            $(".logOut").show();
                        }
                    },
                    error : function (data) {


                        login = false;

                        $(".logIn").hide();
                        $(".logOut").show();

                    }
                });
            }


            function getArticleInfo() {
				if (aid == undefined) {
				    alert("aid 有误 :" + aid);
				    return ;
				}
				$.ajax({
					url : "/article/getArticleById.action",
					type : "get",
					async : false,
					dataType : "json",
					data :{
					    id : aid
					},
					success : function (data) {
						if (data == null || data == undefined) {
						    alert("读取文章失败");
						    return ;
						}

                        author_id = data.uid;

//						清除所有内容
						$("div.article").empty();

                        $("div.article").append($('<h1 class="title">' + data.title + '</h1>'));


                        $p = $('<div class="show-content"> <p> ' + data.time + '</p>' + data.content + "</div>");

                        $("div.article").append($p);


//                        对于每个img 在外面包一层<div>
                        $("p img").each(function () {
                            $img = $(this);
                            if ($(this).parent().prev().length == 0) {
//                                如果外层的p 是第一个节点的话
                                $(this).parent().remove();
                                $out = $('<div class="image-container"></div>');
                                $out.append($img);

                                $(".show-content").prepend($out);
							} else {
                                $prev = $(this).parent().prev();
                                $(this).parent().remove();
                                $out = $('<div class="image-container"></div>');
                                $out.append($img);

                                $out.insertAfter($prev);
							}
                        });

//                        对于每个blockquote在里面加一个<b>
                        $("blockquote").each(function () {
							if ($(this).find("p").length != 0) {
							    $(this).html('<p><b>' + $(this).text() + '</b></p>');
							}
                        });


//                        去除<div class="show-content">里面的h1
                        $("h1").not(".title").remove();




//            获取作者信息，头像，关注，以及基本信息
                        if (author_id == undefined) {
                            alert("该文章没有作者");
                            return;
                        }

                        $.ajax({
                            url : "/user/getUserById.action",
                            data : {
                                id : author_id
                            },
                            dataType : "json",
                            type : "get",
							async : false,
                            success : function (userData) {
                                if (userData == null) {
                                    return ;
								}
                                $('<div class="author">\n' +
                                    '\t\t\t\t\t\t<a class="avatar">\n' +
                                    '\t\t\t\t\t\t\t<img src="../img/author.jpg" />\n' +
                                    '\t\t\t\t\t\t</a>\n' +
                                    '\t\t\t\t\t\t<div class="info">\n' +
                                    '\t\t\t\t\t\t\t<span>\n' +
                                    '\t\t\t\t\t\t\t\t<a href="#">' + userData.username + '</a>\n' +
                                    '\t\t\t\t\t\t\t</span>\n' +
                                    '\t\t\t\t\t\t\t<a id="user-follow-button" class="btn btn-success follow">\n' +
                                    '\t\t\t\t\t\t\t\t<i class="icon-plus"></i>\n' +
                                    '\t\t\t\t\t\t\t\t<span>关注</span>\n' +
                                    '\t\t\t\t\t\t\t</a>\n' +
                                    '\t\t\t\t\t\t\t<div class="meta">\n' +
                                    '\t\t\t\t\t\t\t\t<span>' + data.time +'</span>\n' +
                                    '\t\t\t\t\t\t\t\t<span>阅读 ' + data.readCount +'</span>\n' +
                                    '\t\t\t\t\t\t\t\t<span>评论 ' + data.commentCount +'</span>\n' +
                                    '\t\t\t\t\t\t\t\t<span>喜欢 ' + data.likeCount +'</span>\n' +
                                    '\t\t\t\t\t\t\t</div>\n' +
                                    '\t\t\t\t\t\t</div>\n' +
                                    '\t\t\t\t\t</div>').insertAfter($("h1.title"));
                            }





                        });



//                      获取uid 与 author_id之间的关系

						if (author_id == uid) {
                            $("#user-follow-button").remove();
                        }


                        if (uid == undefined || uid == 0 ) {
                            return ;
                        }


                        $.ajax({
                            url : "/follow/getFollowed.action",
                            type : "get",
                            data : {
                                from : uid ,
                                to : author_id
                            },
                            async : false,
                            dataType : "text",
                            success: function (data) {

                                if (data == 1) {
                                    $("#user-follow-button").removeClass("btn-success");
                                    $("#user-follow-button").addClass("btn-default");
                                    $("#user-follow-button").removeClass("follow");
                                    $("#user-follow-button").addClass("following");
                                    $("#user-follow-button i").removeClass("icon-plus");
                                    $("#user-follow-button i").addClass("icon-ok");
                                    $("#user-follow-button span").text("已关注");

                                    author_like = 1;

                                } else {
                                    $("#user-follow-button").addClass("btn-success");
                                    $("#user-follow-button").removeClass("btn-default");
                                    $("#user-follow-button").removeClass("following");
                                    $("#user-follow-button").addClass("follow");
                                    $("#user-follow-button i").addClass("icon-plus");
                                    $("#user-follow-button i").removeClass("icon-ok");
                                    $("#user-follow-button span").text("关注");

                                    author_like = 0;
                                }
                            }
                        });
                    }
				});

            }


            function updateFollow() {
                if (uid == undefined || uid == 0 ) {
                    return ;
                }

                $.ajax({
                    url : "/follow/updateFollow.action",
                    type :"post",
                    dataType : "text",
                    data : {
                        id : uid
                    },
                    success : function (data) {
                        if (data == 1) {
//					    update 第i个的user 的数据 or ....
//                        alert("update " + id + " Follow info ok");
                        }
                    }
                });
            }

            function updateFan(id) {
                if (id == undefined || id == 0 ) {
                    return ;
                }

                $.ajax({
                    url : "/follow/updateFan.action",
                    type :"post",
                    dataType : "text",
                    data : {
                        id : id
                    },
                    success : function (data) {
                        if (data == 1) {
//					    update 第i个的user 的数据 or ....
//                        alert("update " + id + " Fan info ok");
                        }
                    }
                });
            }

            function updateReadCount() {
                $.ajax({
					url : "/article/updateReadCount.action",
					data : {
					    id : aid
					},
					dataType : "text",
					success : function (data) {

                    }
				});
            }

            function updateCommentCount() {
                $.ajax({
                    url : "/article/updateCommentCount.action",
                    data : {
                        id : aid
                    },
                    dataType : "text",
                    success : function (data) {

                    }
                });
            }

            function updatelikeCount() {
                $.ajax({
                    url : "/article/updatelikeCount.action",
                    data : {
                        id : aid
                    },
					async : false,
                    dataType : "text",
                    success : function (data) {

                    }
                });

                $.ajax({
                    url : "/user/updatelikeCount.action",
                    data : {
                        id : author_id
                    },
                    dataType : "text",
                    success : function (data) {

                    }
				});
            }


            function getMaxDepth() {
                $.ajax({
                    url : "/article/getMaxDepth.action",
                    type : "get",
                    data : {
                        aid : aid
                    },
                    async : false,
                    dataType : "text",
                    success : function (data) {
                        comment_depth = parseInt(data);
                    }
                });
            }

            function getCommentCount() {
                $.ajax({
                    url : "/article/getCommentCount.action",
                    type : "get",
                    data : {
                        aid : aid
                    },
					async : false,
                    dataType : "text",
                    success : function (data) {
                        comment_count = parseInt(data);
                    }
                });
            }

//            order : 0 默认按照时间降序排列
            function search(offset) {
                $.ajax({
					url : "/article/search.action",
					type:"post",
					dataType:"json",
					async : false,
					data:{
					    aid : aid,
						offset : offset,
						order : order ,
                        comment_depth : comment_depth
					},
					success : function (data) {



//					    显示评论数据


//						clear comment-list下的comment
						$("div.comment-list").find(".comment").remove();


						var cur = -1;
						for (var i in data) {
						    if (data[i].depth == cur) {
//						        add sub-comment
								$last = $(".comment-list").find(".comment:last");
								if ($last.find(".sub-comment-list").length == 0) {
								    $last = $last.find(".comment-wrap");

								    $('<div class="sub-comment-list">' +
                                        '<div class="sub-comment">' +
                                        '<p>' +
                                        '<a href="#">' + data[i].commentFrom + ' </a> :' +
                                        '<span>' +
                                        '<a href="#">'+ data[i].commentTo +' </a>' +
                                        data[i].info +
                                        '</span>' +
                                        '</p>' +
                                        '<div class="sub-tool-group">' +
                                        '<span>' + data[i].time + '</span>' +
                                        '<a class="comment-huifu" data-from="' + data[i].commentFrom + '' +
										'" data-id="' + data[i].id + '">' +
                                        '<i class="icon-comment-alt"></i>' +
                                        '<span>回复</span>' +
                                        '</a>' +
                                        '<a class="report">' +
                                        '<span>举报</span>' +
                                        '</a>' +
                                        '</div>' +
                                        '</div>' +
                                        '</div>' +
                                        '</div>').insertAfter($last);

								    $last = $last.siblings(".sub-comment-list");
								    if ($last.find(".more-comment").length == 0) {
								        $last = $last.find(".sub-comment:last");
								        $('<div class="more-comment sub-comment">' +
                                            '<a>' +
                                            '<i class="icon-pencil"></i>' +
                                            '<span>添加新评论</span>' +
                                            '</a>' +
                                            '</div>').insertAfter($last);
									}


								} else {
								    $last = $last.find(".sub-comment:last");

								    $('<div class="sub-comment">' +
                                        '<p>' +
                                        '<a href="#">'+ data[i].commentFrom + ' </a> :' +
                                        '<span>\n' +
                                        '<a href="#">'+ data[i].commentTo + ' </a>' +
                                        data[i].info +
                                        '</span>' +
                                        '</p>' +
                                        '<div class="sub-tool-group">' +
                                        '<span>' + data[i].time + '</span>' +
                                        '<a class="comment-huifu" data-from="' + data[i].commentFrom + '' +
										'" data-id="' + data[i].id + '">' +
                                        '<i class="icon-comment-alt"></i>' +
                                        '<span>回复</span>' +
                                        '</a>' +
                                        '<a class="report">' +
                                        '<span>举报</span>' +
                                        '</a>' +
                                        '</div>' +
                                        '</div>').insertBefore($last);
								}

							} else {
						        cur = data[i].depth;

						        $last = $("body");
						        if ($(".comment-list").find(".comment").length == 0) {
						            $last = $(".comment-list").find(".normal-comment-list");
								} else {
						            $last = $(".comment-list").find(".comment:last");
								}
                                $('<div class="comment">' +
									'<div class="author">' +
									'<a class="avatar">' +

//										img src 还没写 不行就这时候发一个ajax，请求下载并获取图片的url
									'<img src="../img/comment1.jpg" />' +

									'</a>' +
									'<div class="info">' +
									'<a href="#" class="name">' + data[i].commentFrom  + ' </a>' +
									'<div class="meta">' +
									'<span>' + data[i].depth + '楼 · ' + data[i].time +'</span>' +
									'</div>' +
									'</div>' +
									'</div>' +
									'<div class="comment-wrap">' +
									'<p>'+ data[i].info +'</p>' +
									'<div class="tool-group">' +
//										在赞的a标签里增加data-id，来方便对评论赞
									'<a class="comment-zan" data-id="' + data[i].id + '">' +
									'<i class="icon-thumbs-up"></i>' +
									'<span> 赞</span>' +
									'</a>' +
									'<a class="comment-huifu" data-from="' + data[i].commentFrom + '' +
									'" data-id="' + data[i].id + '">' +
									'<i class="icon-comment-alt"></i>' +
									'<span> 回复</span>' +
									'</a>' +
									'</div>' +
									'</div>' +
									'</div>').insertAfter($last);

//						        增加data-depth属性
								$(".comment-list .comment:last").data("depth" , data[i].depth);
							}
						}


//						测试一下data-depth对不对
//						$(".comment").each(function () {
//							console.log($(this).data("depth"));
//                        });

                    }
				});

                pagination(offset +1);

                page_offset = offset;
            }

            function pagination(offset) {

//                根据comment_depth和每页的数量决定分页的个数，以及上一页和下一页
//                把所有的li初始化没有active的样式
//                默认把第offset个li里的a设为active

				var cnt = Math.ceil(comment_depth / 3);

				$(".comment-list ul.pagination").find("li").remove();


//				从offset 向左右两边各加3个页码
				var from = offset > 3 ? offset-3 : 1;
				var to = (cnt - offset + 1 ) > 3 ? offset+3 : cnt;

				console.log("from :" + from);
				console.log("to :" + to);

//				from<= ~ <offset
				for (;from<offset;from++) {
                    $("ul.pagination").append($('<li>' +
                        '<a href="javascript:search(' + parseInt(from-1) + ')">' + from + '</a>' +
                        '</li>'));
				}

//				offset
                $("ul.pagination").append($('<li>' +
                    '<a class="active">' + offset + '</a>' +
                    '</li>'));

				from = offset+1;

//				offset< ~ <=to
                for (;from<=to;from++) {
                    $("ul.pagination").append($('<li>' +
                        '<a href="javascript:search(' + parseInt(from-1) + ')">' + from + '</a>' +
                        '</li>'));
                }


//				最后加上一页和下一页比较方便 。 而不是通过以上一页下一页为基准，在其后/前append元素
				if (offset != 1) {
//				    加上一页
					$("ul.pagination").prepend($('<li>' +
						'<a href="javascript:search(' + parseInt(offset-2) + ')">上一页</a>' +
						'</li>'));
				}

                if (offset != cnt) {
//				    加下一页
                    $("ul.pagination").append($('<li>' +
                        '<a href="javascript:search(' + parseInt(offset) + ')">下一页</a>' +
                        '</li>'));
                }
            }
            
			function comment(comment_from , comment_to , depth , info) {

                if (uid == undefined || comment_from == undefined) {
                    return ;
				}


                var cur_depth = 0;

			    if (comment_to == "" ) {
			        comment_to = null;
				}

				if (depth == 0) {
			        $.ajax({
						url : "/article/getMaxDepth.action",
						type : "get",
						data : {
						    aid : aid
						},
						async : false,
						dataType : "text",
						success : function (data) {
                            cur_depth = parseInt(data) +1 ;
//                            alert(cur_depth);
                        }
					});
				} else {
                    cur_depth = depth;
				}

//				alert("cur_depth : " + cur_depth);

			    $.ajax({
					url : "/article/comment.action",
					data : {
					    aid : aid,
						comment_from : comment_from,
						comment_to : comment_to,
						depth : cur_depth,
						info : info
					},
//					强制等评论完之后再刷新
					async : false ,
					dataType : "text" ,
					type : "post",
					success : function (data) {
					    if (data == 1) {
                            alert("评论成功");
						} else {
                            alert("评论发过去了，但失败了");
                        }

                    },
					error : function () {
						alert("评论失败");
                    }
				});


                updateCommentCount();

            }


//           每次回复/喜欢等按钮点击后 会进行一次是否登录的判断

//			之后用作 如果未登录 就跳转到对应页面 进行跳转操作，登陆后 直接回来
			function judgeLogin() {

				if (login == false) {
				    getSession();
				    if (login == false) {
                        window.location = "/html/login.html?action=article.action&aid="+aid;
					}

				}
            }

//            每次发布新的评论，改变排序方式时以及页面初始化时会强制调用这个函数
            function showComment() {

                getMaxDepth();

                getCommentCount();
//                分页

                $(".top-title span").html(comment_count + "条评论");

//                每页10条评论

//				按照时间逆序排列 ： order = 0

				search(page_offset);

            }

//            获取文章的喜欢数
            function getLikeCount() {
                $.ajax({
                    url : "/article/getLikeCount.action",
                    type :"get",
                    dataType : "text",
                    data : {
                        aid : aid
                    },
                    success : function (data) {
                        $(".like-wrap a").text(data);
                    }
                });
            }

            function like_toggle () {

                if (uid == undefined || comment_from == undefined) {
                    alert("请先登录再进行操作");
                    return ;
                }

                if (like == 0) {

                    $.ajax({
                        url : "/article/like.action",
                        type : "post",
                        dataType:"text",

//                        很重要 like 和 unlike 都要设置成同步的，不然获取LikeCount的值是错误的
                        async : false,

                        data : {
                            uid : uid,
                            aid : aid
                        },
                        success : function (data) {
                            if (data == 1) {
                                $(".btn.like-group").addClass("active");
                                $(".btn.like-group").find(".like i").removeClass("icon-heart-empty");
                                $(".btn.like-group").find(".like i").addClass("icon-heart");


                                $(".side-tool li:eq(2) a").addClass("active");
                                $(".side-tool li:eq(2) a i").removeClass("icon-heart-empty");
                                $(".side-tool li:eq(2) a i").addClass("icon-heart");


                                like = 1;
                            } else {
                                alert("喜欢失败");
                            }

                        }
                    });


                } else {

                    $.ajax({
                        url : "/article/unlike.action",
                        type : "post",
                        dataType:"text",

//                        很重要 like 和 unlike 都要设置成同步的，不然获取LikeCount的值是错误的
                        async : false,

                        data : {
                            uid : uid,
                            aid : aid
                        },
                        success : function (data) {
                            if (data == 1) {
                                $(".btn.like-group").removeClass("active");
                                $(".btn.like-group").find(".like i").removeClass("icon-heart");
                                $(".btn.like-group").find(".like i").addClass("icon-heart-empty");

                                $(".side-tool li:eq(2) a").removeClass("active");
                                $(".side-tool li:eq(2) a i").removeClass("icon-heart");
                                $(".side-tool li:eq(2) a i").addClass("icon-heart-empty");

                                like = 0;
                            } else {
                                alert("取消喜欢失败");
                            }

                        }
                    });

                }
                updatelikeCount();
                getLikeCount();
            }

            function LikeInfo() {


//                获取like_cnt喜欢数
                getLikeCount();


                if (uid == undefined || comment_from == undefined) {
//                    alert("请先登录再进行操作");
                    return ;
                }

//                获取当前文章是否被喜欢了
                $.ajax({
                    url : "/article/getLike.action",
                    type : "get",
                    dataType : "text",
                    data:{
                        aid : aid,
                        uid : uid
                    },
                    success : function (data) {
                        if (data == 1) {

//                            当前用户已经喜欢了这篇文章
                            $(".btn.like-group").addClass("active");
                            $(".btn.like-group").find(".like i").removeClass("icon-heart-empty");
                            $(".btn.like-group").find(".like i").addClass("icon-heart");


                            $(".side-tool li:eq(2) a").addClass("active");
                            $(".side-tool li:eq(2) a i").removeClass("icon-heart-empty");
                            $(".side-tool li:eq(2) a i").addClass("icon-heart");

                            like = 1;
                        } else if (data == 0) {

//                            当前用户没有喜欢这篇文章
                            $(".btn.like-group").removeClass("active");
                            $(".btn.like-group").find(".like i").removeClass("icon-heart");
                            $(".btn.like-group").find(".like i").addClass("icon-heart-empty");

                            $(".side-tool li:eq(2) a").removeClass("active");
                            $(".side-tool li:eq(2) a i").removeClass("icon-heart");
                            $(".side-tool li:eq(2) a i").addClass("icon-heart-empty");
                            like = 0;
                        }
                    },
                    error : function () {
                        alert("获取是否喜欢文章信息失败");
                    }
                });




            }

            function singleZanInfo(id , dom) {

                var $p = $(dom);

//					    获取多少人赞
                $.ajax({
                    url : "/article/zanInfo.action",
                    type: "get",
                    data : {
                        id : id
                    },
                    dataType : "text",
                    async : false ,
                    success : function (data) {
                        if (data >= 1) {
                            $p.find("span").text(" " + data + "人赞");
                        } else {
                            $p.find("span").text(" 赞");
                        }
                    }
                });

//					    获取这条评论是否被comment_from / uid 赞
                if (uid == undefined || comment_from == undefined) {
                    return ;
                }

                $.ajax({
                    url : "/article/getZan.action",
                    type : "get",
                    data : {
                        uid : uid,
                        cid : id
                    },
                    async : false ,
                    dataType : "text",
                    success : function (data) {
                        if (data == 1) {
                            $p.find("i").addClass("active");
                            $p.data("like","1");
                        } else {
                            $p.find("i").removeClass("active");
                            $p.data("like" , "0");
                        }
                    }
                });
            }

            function zanInfo(dom) {

                $p = null;
                if (dom == undefined || dom == null) {
                    $p = $(".comment-zan");
                    console.log("zanInfo : null/undefined" + $p.length);
				} else {
                    $p = $(dom);
                    console.log("zanInfo : " + $p.length);
				}

				$p.each(function () {
					var id = $(this).data("id");
//					alert(id);
					if (id != "" && id != undefined) {

					    singleZanInfo(id , $(this).get(0));

					}
                });
            }


            function enterPress() {
                if (event.keyCode == 13 ) {
                    var text = $(".search-input").val();

                    $.ajax({
                        url : "/search/searchInsert.action",
                        type : "post",
                        async : false,
                        data :{
                            info : text ,
                            id : uid
                        }
                    });

                    if (text != undefined && text != "") {
                        location.href = "/html/search-article.html?text=" + text;
                    }
                }
            }


			$(function () {

			    getSession();


//			    从url里切割出来aid
                if (window.location.search.indexOf("id") != -1) {
                    aid = location.search.substring(location.search.indexOf("=")+1);
                    console.log("aid " + aid);
                }

			    getArticleInfo();

                updateReadCount();

			    showComment();

			    LikeInfo();

                zanInfo(null);

			    $(document).on("click" , ".comment-huifu" ,function () {
			        $parent = $(this).parents(".comment");
					if ($parent.find(".sub-comment-list").length == 0) {
//					    无sub-comment-list时，应当加一个sub-comment-list，然后增加一个form即可
						$last = $parent.find("div:last");
					    $('<div class="sub-comment-list">' +
                            '<form class="new-comment" style="margin-left: 0;">' +
                            '<textarea placeholder="请写下你的评论"></textarea>' +
                            '<div class="write-function-block">' +
                            '<div class="hint">Enter 发表</div>' +
                            '<a class="btn btn-send">发送</a>' +
                            '<a class="cancel comment-quxiao">取消</a>' +
                            '</div>' +
                            '</form>' +
                            '</div>').insertAfter($last);
					} else {
						if ($parent.find(".sub-comment-list .sub-comment").length == 0) {
 //						    无sub-comment-list但无子评论时，直接隐藏sub-comment-list即可
							$parent.find(".sub-comment-list").remove();
						} else{
//						    有sub-comment-list并且有sub-comment的子评论时，只隐藏/增加form即可
							if ($parent.find(".new-comment").length == 0) {
							    $last = $parent.find("div:last");
							    $('<form class="new-comment" style="margin-left: 0;">' +
                                    '<textarea placeholder="请写下你的评论"></textarea>' +
                                    '<div class="write-function-block">' +
                                    '<div class="hint">Enter 发表</div>' +
                                    '<a class="btn btn-send">发送</a>' +
                                    '<a class="cancel comment-quxiao">取消</a>' +
                                    '</div>' +
                                    '</form>').insertAfter($last);

//							    规定 ： @*** 在层主的那个回复点了之后没有@***，其他的点了之后都会有@comment_from的显示
//								思路 : 如果他有一个父类是sub-comment的话，回复会显示@***

//								在textarea里显示@****
								if ($(this).parents(".sub-comment").length > 0) {
//								    如果他没有一个sub-comment的父类，即他是这一层的那个回复
                                    $(this).parents(".comment").find("form.new-comment textarea").val("@"+$(this).data("from")+" ");
                                    $(this).parents(".comment").find("form.new-comment textarea").data("id" , $(this).data("id"));
								}

							} else {

							    if ($(this).parents(".sub-comment").length == 0) {
//							        这一层的那个回复
									if ($(this).parents(".comment").find("form.new-comment textarea").val() == "") {
//									    textarea 为空
                                        $parent.find(".new-comment").remove();
									} else {
                                        $parent.find(".new-comment textarea").val("");
                                        $parent.find(".new-comment textarea").data("id" , $(this).data("id"));
									}
								} else if ($(this).parents(".comment").find("form.new-comment textarea").data("id") == $(this).data("id")) {
//									如果连续点击相同的回复，那么这个回复new-comment将remove掉
//									做法：给这个textarea加一个data("id")，存放上次点击的回复的所在评论的id，通过是否相同进行判重
							        $parent.find(".new-comment").remove();
                                } else {
                                    $parent.find(".new-comment textarea").data("id" , $(this).data("id"));
                                    $parent.find(".new-comment textarea").val("@" + $(this).data("from") + " ");
                                }



//							    if ($(this).parents(".comment").find("form.new-comment textarea").val() == "@"+$(this).data("from")+" ") {
//                                    $parent.find(".new-comment").remove();
//								} else {
//                                    $parent.find(".new-comment textarea").val("@" + $(this).data("from") + " ");
//								}


							}
						}
					}
                });

			    $(document).on("click" , ".comment-zan" , function () {
			        var $p = $(this);
			        var id = $(this).data("id");
			        var ok = $(this).data("like");

			        if (uid == undefined || comment_from == undefined) {
			            return ;
					}

			        if (ok == undefined || ok == "0") {
                        $.ajax({
                            url : "/article/like_comment.action",
                            type : "post",
                            dataType : "text",
                            async : false ,
                            data :{
                                uid : uid,
                                cid : id
                            },
                            success : function (data) {
                                if (data == 1) {
                                    $p.data("like" , "1");
                                    $p.find("i").addClass("active");
                                }
                            },
							error : function (data) {
								alert("喜欢评论失败");
                            }
                        });
					} else {
                        $.ajax({
                            url : "/article/unlike_comment.action",
                            type : "post",
                            dataType : "text",
                            async : false ,
                            data :{
                                uid : uid,
                                cid : id
                            },
                            success : function (data) {
                                if (data == 1) {
                                    $p.data("like" , "0");
                                    $p.find("i").removeClass("active");
                                }
                            },
                            error : function (data) {
                                alert("不喜欢喜欢评论失败");
                            }
                        });
					}

                    singleZanInfo(id , $(this).get(0));

                });

                $(document).on("click", ".comment-quxiao", function () {
                    $list = $(this).parents(".sub-comment-list");
                    if ($list.length == 1 ) {
                        if ($list.find(".sub-comment").length > 0) {
                            $(this).parents("form.new-comment").remove();
						} else {
                            $(this).parents(".sub-comment-list").remove();
						}
					}
                });


                $(document).on("click"  , ".more-comment",function () {
//                    alert($(this).siblings("form.new-comment").length);
					if ($(this).siblings("form.new-comment").length == 0) {
                        $('<form class="new-comment" style="margin-left: 0;">' +
                            '<textarea placeholder="请写下你的评论"></textarea>' +
                            '<div class="write-function-block">' +
                            '<div class="hint">Enter 发表</div>' +
                            '<a class="btn btn-send">发送</a>' +
                            '<a class="cancel comment-quxiao">取消</a>' +
                            '</div>' +
                            '</form>').insertAfter($(this));
					} else {
					    if ($(this).siblings("form.new-comment").find("textarea").val() == "") {
                            $(this).siblings("form.new-comment").remove();
						} else {
//					        防止点击某个子回复的回复，点击添加新评论，再点击那个回复后消失的情况
                            $(this).siblings("form.new-comment").find("textarea").data("id",-1);
                            $(this).siblings("form.new-comment").find("textarea").val("");
						}

					}
                });


                $(document).on("click" , ".btn-send:not(#new-comment-send)" , function () {

                    var info = $(this).parents("form.new-comment").find("textarea").val();
                    var copy_info = info;
//                    alert(info + " - "+ comment_from);


//					初始化发评论 comment-to 和 depth 都置为 "" 和 0 ， 后续可以采用别的的方式直接获取
					var cur_depth = $(this).parents(".comment").data("depth");

					var comment_to = "";
					if (info.indexOf("@") != -1 && info.indexOf(" ") != -1) {
					    comment_to = info.substr( 1 , info.indexOf(" ")-info.indexOf("@")-1);
					    info = info.substr(info.indexOf(" "));
					}
					alert(comment_from + " - " + comment_to + " - " + info + " - " + cur_depth);

					if (comment_to != "") {
					    $.ajax({
							url : "/user/searchUsernameDup.action",
							type:"post",
							dataType:"text",

//							必须强制那个async，不然这个ajax等于无效
							async : false,

							data:{
							    username : comment_to
							},
							success : function (data) {
								if (data == 0) {
//								    如果那个名字不存在的话，则不按照回复@**的格式处理
								    comment_to = "";
                                    info = copy_info;
								}
                            },
							error : function (data) {
								alert("分名字时出现错误");
                                comment_to = "";
                                info = copy_info;
                            }
						});
					}
                    comment(comment_from , comment_to , cur_depth , info);

					showComment();


                });

                $("#new-comment-area").click( function () {
					$("#new-comment-btn").show();
                });

			    $("#new-comment-send").click( function () {

//			        发送评论给action

					var info = $("#new-comment-area").val();
					alert(info + " - "+ comment_from);


//					初始化发评论 comment-to 和 depth 都置为 "" 和 0 ， 后续可以采用别的的方式直接获取
					comment(comment_from , "" , 0 , info);


					$("#new-comment-btn").hide();

					showComment();

//					refresh 评论区域
                });

			    $("#new-comment-cancel").click(function () {
					$("#new-comment-btn").hide();
                });


			    $("#inverse-order-btn").click(function () {
					$(this).addClass("active");
					$("#sequence-order-btn").removeClass("active");

					order = 0;
                    page_offset = 0;

					showComment();
                });

                $("#sequence-order-btn").click(function () {
                    $(this).addClass("active");
                    $("#inverse-order-btn").removeClass("active");

                    order = 1;
                    page_offset = 0;

                    showComment();
                });


                $(".btn.like-group").click(function () {
                    like_toggle();
                });

                $(".side-tool li:eq(2)").click(function () {
                    like_toggle();
                });

                $("#logout-btn").click(function () {

//			    强制刷新重新获取session数据，防止多个浏览器窗口一个退出，其他未退出的情况
                    getSession();

                    if (login == true) {
                        window.location = "/user/logout.action";
                    }
                });

                $(".search-btn").click(function () {
                    var text = $(".search-input").val();

                    $.ajax({
                        url : "/search/searchInsert.action",
                        type : "post",
                        async : false,
                        data :{
                            info : text ,
                            id : uid
                        }
                    });

                    if (text != undefined && text != "") {
                        location.href = "/html/search-article.html?text=" + text;
                    }
                });

                $(document).on("click", "#user-follow-button" ,function () {

                    if (uid == undefined) {
                        alert("请登录啊！！！");
                        return ;
                    }

                    if (author_id == undefined) {
                        alert("没有author_id ！！！");
                        return ;
                    }

                    if (author_like == 0) {

                        $.ajax({
                            url : "/follow/like.action",
                            type : "post",
                            async : false,
                            dataType : "text",
                            data : {
                                from : uid,
                                to : author_id
                            },
                            success : function (data) {
                                if (data == 1) {
                                    $("#user-follow-button").removeClass("btn-success");
                                    $("#user-follow-button").addClass("btn-default");
                                    $("#user-follow-button").removeClass("follow");
                                    $("#user-follow-button").addClass("following");
                                    $("#user-follow-button i").removeClass("icon-plus");
                                    $("#user-follow-button i").addClass("icon-ok");
                                    $("#user-follow-button span").text("已关注");

                                    author_like = 1;
                                } else {
                                    alert("喜欢" + author_id + " 失败");
                                }
                            }
                        });

                    } else {
                        $.ajax({
                            url : "/follow/unlike.action",
                            type : "post",
                            async : false,
                            dataType : "text",
                            data : {
                                from : uid,
                                to : author_id
                            },
                            success : function (data) {
                                if (data == 1) {
                                    $("#user-follow-button").addClass("btn-success");
                                    $("#user-follow-button").removeClass("btn-default");
                                    $("#user-follow-button").removeClass("following");
                                    $("#user-follow-button").addClass("follow");
                                    $("#user-follow-button i").addClass("icon-plus");
                                    $("#user-follow-button i").removeClass("icon-ok");
                                    $("#user-follow-button span").text("关注");

                                    author_like = 0;
                                } else {
                                    alert("不喜欢" + author_id + " 失败");
                                }
                            }
                        });
                    }

                    updateFan(author_id);
                    updateFollow();
                });

			});

		</script>
	
	</head>
	<body>

	<!--导航栏部分-->
	<div class="navbar navbar-default navbar-fixed-top" role="navigation" style="background-color: #FFFFFF; font-size: 20px; ">
		<div class="navbar-header" style="margin-left: 50px; width: 300px;" >
			<!--version 1  ： 一个LOGO -->
			<a href="/index.action" class="navbar-brand" style="font-size: 25px; color: #ea6f5a; font-family:'微软雅黑' ;">文章创作交流网站</a>

		</div>

		<ul class="nav navbar-nav">
			<!--<li class="active"><a href="#">hah1</a></li>-->
			<li><a href="/index.action"><i class="icon-home"></i>首页</a></li>
			<li class="logIn"><a href="/user_main.action"><i class="icon-bell-alt"></i>消息</a></li>
			<li class="logIn"><a href="/followFan.action"><i class="icon-file"></i>关注</a></li>
		</ul>


		<form onkeydown="enterPress()" onclick="return false;" onsubmit="return false;" class="navbar-form navbar-left">

			<!--version 1-->
			<!--<div class="form-group">
                <input type="text" class="form-control" placeholder="搜索" />
                <button type="submit" class="btn btn-default">搜索</button>
            </div>-->

			<!--version 2 搜索框 + icon-->
			<!--<div class="form-group">
                <input type="text" class="form-control" placeholder="搜索" />
                <a href="#"><i class="icon-search"></i></a>
            </div>-->

			<!--version 3 搜索框里 包含icon -->
			<div class="input-group">
				<input type="text" class="search-input" placeholder="搜索"  />
				<a class="search-btn" >
					<i class="icon-search"></i>
				</a>
			</div>
		</form>


		<ul class="nav navbar-nav navbar-right">
			<li class="logOut"><a class="log-in" href="/login.action">登录</a></li>

			<li class="logOut"><a class="btn sign-up" href="/register.action" style="color:#ec6149 ;">注册</a></li>

			<li class="dropdown logIn">
				<a class="dropdown-toggle"  data-toggle="dropdown" style="padding: 5px 15px" >
					<img src="../img/profile.jpg" class="img-circle" width="40px" height="40px">
					<span class="caret"></span>
				</a>

				<ul class="dropdown-menu" style="position: absolute; left: 0px; top: 50px; font-size: 17px;">
					<li style="padding: 5px 20px 5px 0px;"><a href="/user_main.action"><i class="icon-user"></i>我的主页</a></li>
					<li style="padding: 5px 20px 5px 0px;"><a href="user_main.html"><i class="icon-heart"></i>喜欢的文章</a></li>
					<li style="padding: 5px 20px 5px 0px;"><a href="help.html"><i class="icon-wrench"></i>帮助与反馈</a></li>
					<li style="padding: 5px 20px 5px 0px;"><a id="logout-btn" ><i class="icon-signout"></i>退出</a></li>
				</ul>

			</li>
			<!--<li><img src="img/调档函.JPG" class="img-circle" width="40px" height="40px" style="margin-top: 5px;"></li>-->
			<!--<li><a href="#">123</a></li>-->


			<!--版本一 ： 直接一个写文章的li-->
			<!--<li style="margin-right: 80px;"><a href="#"><i class="icon-pencil"></i>写文章</a></li>-->

			<!--版本二： 拿button封装起来的写文章，且自带红色背景-->
			<li style="margin-right: 80px;">
				<a href="#" class="write-block" style="padding-top: 5px; padding-bottom: 5px;">
					<button class="btn write-btn">
						<i class="icon-pencil"></i>写文章
					</button>
				</a>
			</li>
		</ul>

	</div>

	<div class="note" style="margin-top: 70px;">
			
			<div class="fixed-ad-container">
				<div style="display: block;">
					<a class="web-note-ad-fixed" href="#">
						<span>×</span>
					</a>
				</div>
			</div>
			
			<!--文章主题内容的显示-->
			<div class="post">
				<!--显示文章主题内容 包括文字、图片、引用-->
				<div class="article">
					<h1 class="title">去年9月到今年4月，我记录下了旅途中的这些小惊喜</h1>
					
					<!--作者部分-->
					<div class="author">
						<a class="avatar">
							<img src="../img/author.jpg" />
						</a>
						<div class="info">
							<span>
								<a href="#">杨小蟹</a>
							</span>
							<a class="btn btn-success follow">
								<i class="icon-plus"></i>
								<span>关注</span>
							</a>
							<div class="meta">
								<span>2019.04.11 21:13</span>
								<span>字数 1568</span>
								<span>阅读 7872</span>
								<span>评论 56</span>
								<span>喜欢 99</span>
							</div>
						</div>
					</div>
					
					<!--文章部分-->
					<div class="show-content">
						<div class="image-container">
							<img src="../img/photo1.jpg" />
						</div>
						<blockquote>
							<p>
								<b>
									回过头来才发现，原来那些当时用心记录下来的画面，都是流逝时光里不可多得的小美好。
								</b>
							</p>
						</blockquote>
						<p>2019年4月11日  星期四  阴</p>
						<p>文/杨小蟹</p>
						<p><br></p>
						<p>从去年9月到现在，转改有半年多了。</p>
						<p>细细数来，也走过了很多地方，城市和乡野，古镇和寺庙，大山和湖泊。</p>
						<p>
							<b>
								说走就走的旅行，不是不管不顾不闻不问的去往某一个地方，而是今晚决定了，就妥善处理好工作，再做好攻略，明天一早就启程。
							</b>
						</p>
						<div class="image-container">
							<img src="../img/photo2.jpg" />
						</div>
						<p>喜欢在高铁上听着喜欢的歌，看着窗外发呆，想到些什么就记下来。</p>
						<p>我喜欢走累了，就坐在湖边，听着民谣，静看夕阳西下。</p>
						<p>喜欢夜里独自在街头游荡，或者去逛夜市，记录下那些各自忙碌的身影。</p>
						<div class="image-container">
							<img src="../img/photo3.jpg" />
						</div>
						<p>也特别喜欢旅途中遇到的那些个萌娃，微笑打个招呼，逗逗乐。</p>
						<p>为什么喜欢小孩子？</p>
						<p>
							<b>
								因为她们的世界干净，天真童心，思维简单，心灵单纯，相处很舒服很放松。
							</b>
						</p>
						<div class="image-container">
							<img src="../img/photo4.jpg" />
						</div>
						<div class="image-container">
							<img src="../img/photo5.jpg" />
						</div>
						
						<p>
							<b>
								回过头来才发现，原来那些当时用心记录下来的画面，都是流逝时光里不可多得的小美好。
							</b>
						</p>
						<p>
							很多东西，转瞬即逝，即使放进记忆里，时间久了也会淡忘。
						</p>
						<p>
							恰好文字和照片可以帮我们记得。
						</p>
						<p>
							做一个用心记录生活的人，将来一定可以转化为某种“财富”。
						</p>
					</div>
				</div>
				
				<!--显示文章类型、以及版权问题-->
				<div class="show-foot">
					<div class="notebook">
						<i class="icon-bookmark"></i>
						<span>旅行、摄影</span>
					</div>
					<div class="copyright">
						© 著作权归作者所有
					</div>
				</div>
			
				<!--显示喜欢、以及分享部分-->
				<div class="meta-bottom">
					<div class="btn like-group">
						<div class="like">
							<a>
								<i class="icon-heart-empty"></i>
								<span>喜欢</span>
							</a>
						</div>
						<div class="like-wrap">
							<a>117</a>
						</div>
					</div>
					<div class="share-group">
						<a class="share-circle">
							<i class="icon-facebook" style="color: #00bb29;"></i>
						</a>
						
						<a class="share-circle">
							<i class="icon-twitter" style="color: #e05244;"></i>
						</a>
						
						<a class="share-circle">
							<i class="icon-linkedin" style="color: #9b9b9b;"></i>
						</a>
						
						<a class="share-circle more-share">
							更多分享
						</a>
					</div>
				</div>
			
				<!--评论部分-->
				
				<div class="comment-list">
					
					<!--自己写评论部分-->
					<form class="new-comment">
						<a class="avatar">
							<img src="../img/profile.jpg" />
						</a>
						<textarea id="new-comment-area" placeholder="请写下你的评论"></textarea>
						
						<div id="new-comment-btn" class="write-function-block">
							<div class="hint">Enter 发表</div>
							<a id="new-comment-send" class="btn btn-send">发送</a>
							<a id="new-comment-cancel" class="cancel">取消</a>
						</div>
					</form>
					
					<!--评论列表-->
					<div class="normal-comment-list">
						<div class="top-title">
							<span>79条评论</span>
							<div class="pull-right">
								<a id="inverse-order-btn" class="active">按时间倒序</a>
								<a id="sequence-order-btn">按时间正序</a>
							</div>
						</div>
					</div>
					
					<!--评论内容-->
					
					<!--未点击回复，没回复的评论-->
					<div class="comment">
						<div class="author">
							<a class="avatar">
								<img src="../img/comment1.jpg" />
							</a>
							<div class="info">
								<a href="#" class="name">喵媛</a>
								<div class="meta">
									<span>45楼 · 2019.04.16 16:06</span>
								</div>
							</div>
						</div>
						<div class="comment-wrap">
							<p>善于发现小美好的小哥哥</p>
							<div class="tool-group">
								<a>
									<i class="icon-thumbs-up"></i>
									<span>赞</span>
								</a>
								
								<a class="comment-huifu">
									<i class="icon-comment-alt"></i>
									<span>回复</span>
								</a>
							</div>
						</div>
					</div>
					
					<!--没有回复，点击回复后，多了一个<div class="sub-comment">-->
					<div class="comment">
						<div class="author">
							<a class="avatar">
								<img src="../img/comment1.jpg" />
							</a>
							<div class="info">
								<a href="#" class="name">喵媛</a>
								<div class="meta">
									<span>45楼 · 2019.04.16 16:06</span>
								</div>
							</div>
						</div>
						<div class="comment-wrap">
							<p>善于发现小美好的小哥哥</p>
							<div class="tool-group">
								<a>
									<i class="icon-thumbs-up"></i>
									<span>赞</span>
								</a>
								
								<a class="comment-huifu">
									<i class="icon-comment-alt"></i>
									<span>回复</span>
								</a>
							</div>
						</div>
						
						<div class="sub-comment-list">
							<form class="new-comment" style="margin-left: 0;">
								
								<textarea placeholder="请写下你的评论"></textarea>
								
								<div class="write-function-block">
									<div class="hint">Enter 发表</div>
									<a class="btn btn-send">发送</a>
									<a class="cancel comment-quxiao">取消</a>
								</div>
							</form>
						</div>
					</div>
					
					
					<!--多条评论的回复，点击回复后-->
					<div class="comment">
						<div class="author">
							<a class="avatar">
								<img src="../img/comment2.jpg" />
							</a>
							<div class="info">
								<a href="#" class="name">名言诗句</a>
								<div class="meta">
									<span>33楼 · 2019.04.15 17:53</span>
								</div>
							</div>
						</div>
						<div class="comment-wrap">
							<p>做一个用心记录生活的人。这个想法很好。点赞！</p>
							<div class="tool-group">
								<a>
									<i class="icon-thumbs-up"></i>
									<span>赞</span>
								</a>
								
								<a class="comment-huifu">
									<i class="icon-comment-alt"></i>
									<span>回复</span>
								</a>
							</div>
						</div>
						
						<!--多出来的部分-->
						<div class="sub-comment-list">
							<div class="sub-comment">
								<p>
									<a href="#">杨小蟹</a> :
									<span>
										<a href="#">@名言诗句</a>
										 嘿嘿，谢谢啦。我们都可以用心去记录
									</span>
								</p>
								<div class="sub-tool-group">
									<span>2019.04.16 12:17</span>
									<a class="comment-huifu">
										<i class="icon-comment-alt"></i>
										<span>回复</span>
									</a>
									<a class="report">
										<span>举报</span>
									</a>
								</div>
							</div>
							
							<div class="sub-comment">
								<p>
									<a href="#">微风缓缓</a> :
									<span>
										<!--<a href="#">@名言诗句</a>-->
										 回忆的祈祷。好美，舒服的感觉，也安静怡然。
									</span>
								</p>
								<div class="sub-tool-group">
									<span>2019.04.16 15:59</span>
									<a class="comment-huifu">
										<i class="icon-comment-alt"></i>
										<span>回复</span>
									</a>
									<a class="report">
										<span>举报</span>
									</a>
								</div>
							</div>
							
							<div class="more-comment sub-comment">
								<a>
									<i class="icon-pencil"></i>
									<span>添加新评论</span>
								</a>
							</div>
							
							<form class="new-comment" style="margin-left: 0;">
								
								<textarea placeholder="请写下你的评论"></textarea>
								
								<div class="write-function-block">
									<div class="hint">Enter 发表</div>
									<a class="btn btn-send">发送</a>
									<a class="cancel comment-quxiao">取消</a>
								</div>
							</form>
						</div>
					</div>
					
				
					<ul class="pagination">
						<!--<li>-->
							<!--<a class="active" href="#">1</a>-->
						<!--</li>-->
						<!--<li>-->
							<!--<a href="#">2</a>-->
						<!--</li>-->
						<!--<li>-->
							<!--<a href="#">3</a>-->
						<!--</li>-->
						<!--<li>-->
							<!--<a href="#">4</a>-->
						<!--</li>-->
						<!--<li>-->
							<!--<a href="#">下一页</a>-->
						<!--</li>-->
					</ul>
					
				</div>
				
			</div>
			
			<!--右下角的几个快捷按钮组-->
			<div class="side-tool">
				<ul>
					<li>
						<a>
							<i class="icon-angle-up"></i>
						</a>
					</li>
					
					<li>
						<a>
							<i class="icon-bookmark-empty"></i>
						</a>
					</li>
					
					<li>
						<a>
							<i class="icon-heart-empty"></i>
						</a>
					</li>
					
					<li>
						<a>
							<i class="icon-angle-down"></i>
						</a>
					</li>
					
					<!--分享 按钮-->
					<!--<li>
						<a>
							<i class="icon-angle-up"></i>
						</a>
					</li>-->
				</ul>
			</div>
			
			
		</div>
		
		
	</body>
</html>
