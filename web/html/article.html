<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title></title>

		<link rel="stylesheet" href="../css/bootstrap.min.css" />
		<link rel="stylesheet" href="../css/font-awesome.min.css" />
		<link rel="stylesheet" href="../css/platform.css" />
		<script type="text/javascript" src="../js/jquery.min.js" ></script>
		<script type="text/javascript" src="../js/bootstrap.min.js" ></script>


		<script type="text/javascript">


			<!--article information 初始化部分 -->
			var aid = 1;
			var comment_from;

            var login = false;

            var comment_depth = 0;
            var comment_count = 0;

            function getSession() {

                $.ajax({
                    url : "/user/getSession.action",
                    type : "get",
                    dataType : "json",
                    success : function (data) {
                        if (data != null ) {
//                        alert("id : " + data.id + " username : " + data.username + " info : " + data.info);

                            login = true;
                            comment_from = data.username;

//				        隐藏nav的按钮
                            $(".logIn").show();
                            $(".logOut").hide();
                        } else {

                            login = false;

                            $(".logIn").hide();
                            $(".logOut").show();
                        }
                    },
                    error : function (data) {


                        login = false;

                        $(".logIn").hide();
                        $(".logOut").show();

                    }
                });
            }

            function getMaxDepth() {
                $.ajax({
                    url : "/article/getMaxDepth.action",
                    type : "get",
                    data : {
                        aid : aid
                    },
                    async : false,
                    dataType : "text",
                    success : function (data) {
                        comment_depth = parseInt(data);
                    }
                });
            }

            function getCommentCount() {
                $.ajax({
                    url : "/article/getCommentCount.action",
                    type : "get",
                    data : {
                        aid : aid
                    },
                    dataType : "text",
                    success : function (data) {
                        comment_count = parseInt(data);
                    }
                });
            }

//            order : 0 默认按照时间降序排列
            function search(offset , order) {
                $.ajax({
					url : "/article/search.action",
					type:"post",
					dataType:"json",
					data:{
					    aid : aid,
						offset : offset,
						order : order ,
                        comment_depth : comment_depth
					},
					success : function (data) {



//					    显示评论数据


//						clear comment-list下的comment
//						$("div.comment-list").find(".comment").remove();


						var cur = -1;
						for (var i in data) {
						    if (data[i].depth == cur) {
//						        add sub-comment
								$last = $(".comment-list").find(".comment:last");
								if ($last.find(".sub-comment-list").length == 0) {
								    $last = $last.find(".comment-wrap");

								    $('<div class="sub-comment-list">' +
                                        '<div class="sub-comment">' +
                                        '<p>' +
                                        '<a href="#">' + data[i].commentFrom + ' </a> :' +
                                        '<span>' +
                                        '<a href="#">'+ data[i].commentTo +' </a>' +
                                        data[i].info +
                                        '</span>' +
                                        '</p>' +
                                        '<div class="sub-tool-group">' +
                                        '<span>' + data[i].time + '</span>' +
                                        '<a class="comment-huifu">' +
                                        '<i class="icon-comment-alt"></i>' +
                                        '<span>回复</span>' +
                                        '</a>' +
                                        '<a class="report">' +
                                        '<span>举报</span>' +
                                        '</a>' +
                                        '</div>' +
                                        '</div>' +
                                        '</div>' +
                                        '</div>').insertAfter($last);

								    $last = $last.siblings(".sub-comment-list");
								    if ($last.find(".more-comment").length == 0) {
								        $last = $last.find(".sub-comment:last");
								        $('<div class="more-comment sub-comment">' +
                                            '<a>' +
                                            '<i class="icon-pencil"></i>' +
                                            '<span>添加新评论</span>' +
                                            '</a>' +
                                            '</div>').insertAfter($last);
									}


								} else {
								    $last = $last.find(".sub-comment:last");

								    $('<div class="sub-comment">' +
                                        '<p>' +
                                        '<a href="#">'+ data[i].commentFrom + ' </a> :' +
                                        '<span>\n' +
                                        '<a href="#">'+ data[i].commentTo + ' </a>' +
                                        data[i].info +
                                        '</span>' +
                                        '</p>' +
                                        '<div class="sub-tool-group">' +
                                        '<span>' + data[i].time + '</span>' +
                                        '<a class="comment-huifu">' +
                                        '<i class="icon-comment-alt"></i>' +
                                        '<span>回复</span>' +
                                        '</a>' +
                                        '<a class="report">' +
                                        '<span>举报</span>' +
                                        '</a>' +
                                        '</div>' +
                                        '</div>').insertBefore($last);
								}

							} else {
						        cur = data[i].depth;

						        $last = $("body");
						        if ($(".comment-list").find(".comment").length == 0) {
						            $last = $(".comment-list").find(".normal-comment-list");
								} else {
						            $last = $(".comment-list").find(".comment:last");
								}
                                $('<div class="comment">' +
									'<div class="author">' +
									'<a class="avatar">' +

//										img src 还没写 不行就这时候发一个ajax，请求下载并获取图片的url
									'<img src="../img/comment1.jpg" />' +

									'</a>' +
									'<div class="info">' +
									'<a href="#" class="name">' + data[i].commentFrom  + ' </a>' +
									'<div class="meta">' +
									'<span>' + data[i].depth + '楼 · ' + data[i].time +'</span>' +
									'</div>' +
									'</div>' +
									'</div>' +
									'<div class="comment-wrap">' +
									'<p>'+ data[i].info +'</p>' +
									'<div class="tool-group">' +
									'<a>' +
									'<i class="icon-thumbs-up"></i>' +
									'<span>赞</span>' +
									'</a>' +
									'<a class="comment-huifu">' +
									'<i class="icon-comment-alt"></i>' +
									'<span>回复</span>' +
									'</a>' +
									'</div>' +
									'</div>' +
									'</div>').insertAfter($last);
							}
						}

                    }
				});
            }

			function comment(comment_from , comment_to , depth , info) {

                var cur_depth = 0;

			    if (comment_to == "" ) {
			        comment_to = null;
				}

				if (depth == 0) {
			        $.ajax({
						url : "/article/getMaxDepth.action",
						type : "get",
						data : {
						    aid : aid
						},
						async : false,
						dataType : "text",
						success : function (data) {
                            cur_depth = parseInt(data) +1 ;
                            alert(cur_depth);
                        }
					});
				} else {
                    cur_depth = depth;
				}

				alert("cur_depth : " + cur_depth);

			    $.ajax({
					url : "/article/comment.action",
					data : {
					    aid : aid,
						comment_from : comment_from,
						comment_to : comment_to,
						depth : cur_depth,
						info : info
					},
					dataType : "text" ,
					type : "post",
					success : function (data) {
					    if (data == 1) {
                            alert("评论成功");
						} else {
                            alert("评论发过去了，但失败了");
                        }

                    },
					error : function () {
						alert("评论失败");
                    }
				});

            }


//           每次回复/喜欢等按钮点击后 会进行一次是否登录的判断
			function judgeLogin() {
				if (login == false) {
				    window.location = "/html/login.html?aid="+aid;
				}
            }

            function showComment() {
                getMaxDepth();

                getCommentCount();
//                分页

                $(".top-title span").html(comment_depth + "条评论");

//                每页10条评论
				search(0 , 0);
//				显示评论数据

            }


			$(function () {

			    getSession();

			    showComment();

			    $(document).on("click" , ".comment-huifu" ,function () {
			        $parent = $(this).parents(".comment");
					if ($parent.find(".sub-comment-list").length == 0) {
//					    无sub-comment-list时，应当加一个sub-comment-list，然后增加一个form即可
						$last = $parent.find("div:last");
					    $('<div class="sub-comment-list">' +
                            '<form class="new-comment" style="margin-left: 0;">' +
                            '<textarea placeholder="请写下你的评论"></textarea>' +
                            '<div class="write-function-block">' +
                            '<div class="hint">Enter 发表</div>' +
                            '<a class="btn btn-send">发送</a>' +
                            '<a class="cancel comment-quxiao">取消</a>' +
                            '</div>' +
                            '</form>' +
                            '</div>').insertAfter($last);
					} else {
						if ($parent.find(".sub-comment-list .sub-comment").length == 0) {
 //						    无sub-comment-list但无子评论时，直接隐藏sub-comment-list即可
							$parent.find(".sub-comment-list").remove();
						} else{
//						    有sub-comment-list并且有sub-comment的子评论时，只隐藏/增加form即可
							if ($parent.find(".new-comment").length == 0) {
							    $last = $parent.find("div:last");
							    $('<form class="new-comment" style="margin-left: 0;">' +
                                    '<textarea placeholder="请写下你的评论"></textarea>' +
                                    '<div class="write-function-block">' +
                                    '<div class="hint">Enter 发表</div>' +
                                    '<a class="btn btn-send">发送</a>' +
                                    '<a class="cancel comment-quxiao">取消</a>' +
                                    '</div>' +
                                    '</form>').insertAfter($last);
							} else {
                                $parent.find(".new-comment").remove();
							}
						}
					}
                });


                $(document).on("click", ".comment-quxiao", function () {
                    $list = $(this).parents(".sub-comment-list");
                    if ($list.length == 1 ) {
                        if ($list.find(".sub-comment").length > 0) {
                            $(this).parents("form.new-comment").remove();
						} else {
                            $(this).parents(".sub-comment-list").remove();
						}
					}
                });


                $(document).on("click"  , ".more-comment",function () {
//                    alert($(this).siblings("form.new-comment").length);
					if ($(this).siblings("form.new-comment").length == 0) {
                        $('<form class="new-comment" style="margin-left: 0;">' +
                            '<textarea placeholder="请写下你的评论"></textarea>' +
                            '<div class="write-function-block">' +
                            '<div class="hint">Enter 发表</div>' +
                            '<a class="btn btn-send">发送</a>' +
                            '<a class="cancel comment-quxiao">取消</a>' +
                            '</div>' +
                            '</form>').insertAfter($(this));
					} else {
                        $(this).siblings("form.new-comment").remove();
					}
                });


                $("#new-comment-area").click( function () {
					$("#new-comment-btn").show();
                });

			    $("#new-comment-send").click( function () {

//			        发送评论给action

					var info = $("#new-comment-area").val();
					alert(info + " - "+ comment_from);


//					初始化发评论 comment-to 和 depth 都置为 "" 和 0 ， 后续可以采用别的的方式直接获取
					comment(comment_from , "" , 0 , info);


					$("#new-comment-btn").hide();

//					refresh 评论区域
                });

			    $("#new-comment-cancel").click(function () {
					$("#new-comment-btn").hide();
                });

            });

		</script>
	
	</head>
	<body>

	<!--导航栏部分-->
	<div class="navbar navbar-default navbar-fixed-top" role="navigation" style="background-color: #FFFFFF; font-size: 20px; ">
		<div class="navbar-header" style="margin-left: 50px; width: 300px;" >
			<!--version 1  ： 一个LOGO -->
			<a href="/index.action" class="navbar-brand" style="font-size: 25px; color: #ea6f5a; font-family:'微软雅黑' ;">文章创作交流网站</a>

		</div>

		<ul class="nav navbar-nav">
			<!--<li class="active"><a href="#">hah1</a></li>-->
			<li><a href="/index.action"><i class="icon-home"></i>首页</a></li>
			<li class="logIn"><a href="/user_main.action"><i class="icon-bell-alt"></i>消息</a></li>
			<li class="logIn"><a href="/followFan.action"><i class="icon-file"></i>关注</a></li>
		</ul>


		<form action="#" class="navbar-form navbar-left">

			<!--version 1-->
			<!--<div class="form-group">
                <input type="text" class="form-control" placeholder="搜索" />
                <button type="submit" class="btn btn-default">搜索</button>
            </div>-->

			<!--version 2 搜索框 + icon-->
			<!--<div class="form-group">
                <input type="text" class="form-control" placeholder="搜索" />
                <a href="#"><i class="icon-search"></i></a>
            </div>-->

			<!--version 3 搜索框里 包含icon -->
			<div class="input-group">
				<input type="text" class="form-control" placeholder="搜索" style="font-size:13px ;background-color: #EEEEEE; border: 0px; border-bottom-left-radius :40px ; border-top-left-radius: 40px;" />
				<a href="#" class="input-group-addon" style="text-decoration: none; border: 0px; border-bottom-right-radius: 40px; border-top-right-radius: 40px; box-shadow: none;"><i class="icon-search"></i></a>
			</div>
		</form>


		<ul class="nav navbar-nav navbar-right">
			<li class="logOut"><a class="log-in" href="/login.action">登录</a></li>

			<li class="logOut"><a class="btn sign-up" href="/register.action" style="color:#ec6149 ;">注册</a></li>

			<li class="dropdown logIn">
				<a class="dropdown-toggle"  data-toggle="dropdown" style="padding: 5px 15px" >
					<img src="../img/profile.jpg" class="img-circle" width="40px" height="40px">
					<span class="caret"></span>
				</a>

				<ul class="dropdown-menu" style="position: absolute; left: 0px; top: 50px; font-size: 17px;">
					<li style="padding: 5px 20px 5px 0px;"><a href=""><i class="icon-user"></i>我的主页</a></li>
					<li style="padding: 5px 20px 5px 0px;"><a href="user_main.html"><i class="icon-heart"></i>喜欢的文章</a></li>
					<li style="padding: 5px 20px 5px 0px;"><a href="help.html"><i class="icon-wrench"></i>帮助与反馈</a></li>
					<li style="padding: 5px 20px 5px 0px;"><a id="logout-btn" ><i class="icon-signout"></i>退出</a></li>
				</ul>

			</li>
			<!--<li><img src="img/调档函.JPG" class="img-circle" width="40px" height="40px" style="margin-top: 5px;"></li>-->
			<!--<li><a href="#">123</a></li>-->


			<!--版本一 ： 直接一个写文章的li-->
			<!--<li style="margin-right: 80px;"><a href="#"><i class="icon-pencil"></i>写文章</a></li>-->

			<!--版本二： 拿button封装起来的写文章，且自带红色背景-->
			<li style="margin-right: 80px;">
				<a href="#" class="write-block" style="padding-top: 5px; padding-bottom: 5px;">
					<button class="btn write-btn">
						<i class="icon-pencil"></i>写文章
					</button>
				</a>
			</li>
		</ul>

	</div>

	<div class="note" style="margin-top: 70px;">
			
			<div class="fixed-ad-container">
				<div style="display: block;">
					<a class="web-note-ad-fixed" href="#">
						<span>×</span>
					</a>
				</div>
			</div>
			
			<!--文章主题内容的显示-->
			<div class="post">
				<!--显示文章主题内容 包括文字、图片、引用-->
				<div class="article">
					<h1 class="title">去年9月到今年4月，我记录下了旅途中的这些小惊喜</h1>
					
					<!--作者部分-->
					<div class="author">
						<a class="avatar">
							<img src="../img/author.jpg" />
						</a>
						<div class="info">
							<span>
								<a href="#">杨小蟹</a>
							</span>
							<a class="btn btn-success follow">
								<i class="icon-plus"></i>
								<span>关注</span>
							</a>
							<div class="meta">
								<span>2019.04.11 21:13</span>
								<span>字数 1568</span>
								<span>阅读 7872</span>
								<span>评论 56</span>
								<span>喜欢 99</span>
							</div>
						</div>
					</div>
					
					<!--文章部分-->
					<div class="show-content">
						<div class="image-container">
							<img src="../img/photo1.jpg" />
						</div>
						<blockquote>
							<p>
								<b>
									回过头来才发现，原来那些当时用心记录下来的画面，都是流逝时光里不可多得的小美好。
								</b>
							</p>
						</blockquote>
						<p>2019年4月11日  星期四  阴</p>
						<p>文/杨小蟹</p>
						<p><br></p>
						<p>从去年9月到现在，转改有半年多了。</p>
						<p>细细数来，也走过了很多地方，城市和乡野，古镇和寺庙，大山和湖泊。</p>
						<p>
							<b>
								说走就走的旅行，不是不管不顾不闻不问的去往某一个地方，而是今晚决定了，就妥善处理好工作，再做好攻略，明天一早就启程。
							</b>
						</p>
						<div class="image-container">
							<img src="../img/photo2.jpg" />
						</div>
						<p>喜欢在高铁上听着喜欢的歌，看着窗外发呆，想到些什么就记下来。</p>
						<p>我喜欢走累了，就坐在湖边，听着民谣，静看夕阳西下。</p>
						<p>喜欢夜里独自在街头游荡，或者去逛夜市，记录下那些各自忙碌的身影。</p>
						<div class="image-container">
							<img src="../img/photo3.jpg" />
						</div>
						<p>也特别喜欢旅途中遇到的那些个萌娃，微笑打个招呼，逗逗乐。</p>
						<p>为什么喜欢小孩子？</p>
						<p>
							<b>
								因为她们的世界干净，天真童心，思维简单，心灵单纯，相处很舒服很放松。
							</b>
						</p>
						<div class="image-container">
							<img src="../img/photo4.jpg" />
						</div>
						<div class="image-container">
							<img src="../img/photo5.jpg" />
						</div>
						
						<p>
							<b>
								回过头来才发现，原来那些当时用心记录下来的画面，都是流逝时光里不可多得的小美好。
							</b>
						</p>
						<p>
							很多东西，转瞬即逝，即使放进记忆里，时间久了也会淡忘。
						</p>
						<p>
							恰好文字和照片可以帮我们记得。
						</p>
						<p>
							做一个用心记录生活的人，将来一定可以转化为某种“财富”。
						</p>
					</div>
				</div>
				
				<!--显示文章类型、以及版权问题-->
				<div class="show-foot">
					<div class="notebook">
						<i class="icon-bookmark"></i>
						<span>旅行、摄影</span>
					</div>
					<div class="copyright">
						© 著作权归作者所有
					</div>
				</div>
			
				<!--显示喜欢、以及分享部分-->
				<div class="meta-bottom">
					<div class="btn like-group">
						<div class="like">
							<a>
								<i class="icon-heart-empty"></i>
								<span>喜欢</span>
							</a>
						</div>
						<div class="like-wrap">
							<a>117</a>
						</div>
					</div>
					<div class="share-group">
						<a class="share-circle">
							<i class="icon-facebook" style="color: #00bb29;"></i>
						</a>
						
						<a class="share-circle">
							<i class="icon-twitter" style="color: #e05244;"></i>
						</a>
						
						<a class="share-circle">
							<i class="icon-linkedin" style="color: #9b9b9b;"></i>
						</a>
						
						<a class="share-circle more-share">
							更多分享
						</a>
					</div>
				</div>
			
				<!--评论部分-->
				
				<div class="comment-list">
					
					<!--自己写评论部分-->
					<form class="new-comment">
						<a class="avatar">
							<img src="../img/profile.jpg" />
						</a>
						<textarea id="new-comment-area" placeholder="请写下你的评论"></textarea>
						
						<div id="new-comment-btn" class="write-function-block">
							<div class="hint">Enter 发表</div>
							<a id="new-comment-send" class="btn btn-send">发送</a>
							<a id="new-comment-cancel" class="cancel">取消</a>
						</div>
					</form>
					
					<!--评论列表-->
					<div class="normal-comment-list">
						<div class="top-title">
							<span>79条评论</span>
							<div class="pull-right">
								<a class="active">按时间倒序</a>
								<a>按时间正序</a>
							</div>
						</div>
					</div>
					
					<!--评论内容-->
					
					<!--未点击回复，没回复的评论-->
					<div class="comment">
						<div class="author">
							<a class="avatar">
								<img src="../img/comment1.jpg" />
							</a>
							<div class="info">
								<a href="#" class="name">喵媛</a>
								<div class="meta">
									<span>45楼 · 2019.04.16 16:06</span>
								</div>
							</div>
						</div>
						<div class="comment-wrap">
							<p>善于发现小美好的小哥哥</p>
							<div class="tool-group">
								<a>
									<i class="icon-thumbs-up"></i>
									<span>赞</span>
								</a>
								
								<a class="comment-huifu">
									<i class="icon-comment-alt"></i>
									<span>回复</span>
								</a>
							</div>
						</div>
					</div>
					
					<!--没有回复，点击回复后，多了一个<div class="sub-comment">-->
					<div class="comment">
						<div class="author">
							<a class="avatar">
								<img src="../img/comment1.jpg" />
							</a>
							<div class="info">
								<a href="#" class="name">喵媛</a>
								<div class="meta">
									<span>45楼 · 2019.04.16 16:06</span>
								</div>
							</div>
						</div>
						<div class="comment-wrap">
							<p>善于发现小美好的小哥哥</p>
							<div class="tool-group">
								<a>
									<i class="icon-thumbs-up"></i>
									<span>赞</span>
								</a>
								
								<a class="comment-huifu">
									<i class="icon-comment-alt"></i>
									<span>回复</span>
								</a>
							</div>
						</div>
						
						<div class="sub-comment-list">
							<form class="new-comment" style="margin-left: 0;">
								
								<textarea placeholder="请写下你的评论"></textarea>
								
								<div class="write-function-block">
									<div class="hint">Enter 发表</div>
									<a class="btn btn-send">发送</a>
									<a class="cancel comment-quxiao">取消</a>
								</div>
							</form>
						</div>
					</div>
					
					
					<!--多条评论的回复，点击回复后-->
					<div class="comment">
						<div class="author">
							<a class="avatar">
								<img src="../img/comment2.jpg" />
							</a>
							<div class="info">
								<a href="#" class="name">名言诗句</a>
								<div class="meta">
									<span>33楼 · 2019.04.15 17:53</span>
								</div>
							</div>
						</div>
						<div class="comment-wrap">
							<p>做一个用心记录生活的人。这个想法很好。点赞！</p>
							<div class="tool-group">
								<a>
									<i class="icon-thumbs-up"></i>
									<span>赞</span>
								</a>
								
								<a class="comment-huifu">
									<i class="icon-comment-alt"></i>
									<span>回复</span>
								</a>
							</div>
						</div>
						
						<!--多出来的部分-->
						<div class="sub-comment-list">
							<div class="sub-comment">
								<p>
									<a href="#">杨小蟹</a> :
									<span>
										<a href="#">@名言诗句</a>
										 嘿嘿，谢谢啦。我们都可以用心去记录
									</span>
								</p>
								<div class="sub-tool-group">
									<span>2019.04.16 12:17</span>
									<a class="comment-huifu">
										<i class="icon-comment-alt"></i>
										<span>回复</span>
									</a>
									<a class="report">
										<span>举报</span>
									</a>
								</div>
							</div>
							
							<div class="sub-comment">
								<p>
									<a href="#">微风缓缓</a> :
									<span>
										<!--<a href="#">@名言诗句</a>-->
										 回忆的祈祷。好美，舒服的感觉，也安静怡然。
									</span>
								</p>
								<div class="sub-tool-group">
									<span>2019.04.16 15:59</span>
									<a class="comment-huifu">
										<i class="icon-comment-alt"></i>
										<span>回复</span>
									</a>
									<a class="report">
										<span>举报</span>
									</a>
								</div>
							</div>
							
							<div class="more-comment sub-comment">
								<a>
									<i class="icon-pencil"></i>
									<span>添加新评论</span>
								</a>
							</div>
							
							<form class="new-comment" style="margin-left: 0;">
								
								<textarea placeholder="请写下你的评论"></textarea>
								
								<div class="write-function-block">
									<div class="hint">Enter 发表</div>
									<a class="btn btn-send">发送</a>
									<a class="cancel comment-quxiao">取消</a>
								</div>
							</form>
						</div>
					</div>
					
				
					<ul class="pagination">
						<li>
							<a class="active" href="#">1</a>
						</li>
						<li>
							<a href="#">2</a>
						</li>
						<li>
							<a href="#">3</a>
						</li>
						<li>
							<a href="#">4</a>
						</li>
						<li>
							<a href="#">下一页</a>
						</li>
					</ul>
					
				</div>
				
			</div>
			
			<!--右下角的几个快捷按钮组-->
			<div class="side-tool">
				<ul>
					<li>
						<a>
							<i class="icon-angle-up"></i>
						</a>
					</li>
					
					<li>
						<a>
							<i class="icon-bookmark-empty"></i>
						</a>
					</li>
					
					<li>
						<a>
							<i class="icon-heart-empty"></i>
						</a>
					</li>
					
					<li>
						<a>
							<i class="icon-angle-down"></i>
						</a>
					</li>
					
					<!--分享 按钮-->
					<!--<li>
						<a>
							<i class="icon-angle-up"></i>
						</a>
					</li>-->
				</ul>
			</div>
			
			
		</div>
		
		
	</body>
</html>
